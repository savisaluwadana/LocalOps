events {
    worker_connections 1024;
}

http {
    upstream stable {
        server stable:3000 weight=9;
    }

    upstream canary {
        server canary:3000 weight=1;
    }

    # Combined upstream with weights (90% stable, 10% canary)
    upstream backend {
        server stable:3000 weight=90;
        server canary:3000 weight=10;
    }

    server {
        listen 80;

        location /health {
            return 200 '{"status": "ok"}';
            add_header Content-Type application/json;
        }

        # Direct access for testing
        location /stable {
            proxy_pass http://stable/;
        }

        location /canary {
            proxy_pass http://canary/;
        }

        # Main traffic - weighted
        location / {
            proxy_pass http://backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
