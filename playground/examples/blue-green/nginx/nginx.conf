events {
    worker_connections 1024;
}

http {
    upstream blue {
        server blue:3000;
    }

    upstream green {
        server green:3000;
    }

    # Active environment - change this to switch traffic
    # Options: blue, green
    map $uri $backend {
        ~^/test-blue   blue;
        ~^/test-green  green;
        default        blue;  # ACTIVE ENVIRONMENT
    }

    server {
        listen 80;

        location /health {
            return 200 '{"status": "ok"}';
            add_header Content-Type application/json;
        }

        # Direct access to blue for testing
        location /test-blue {
            proxy_pass http://blue/;
        }

        # Direct access to green for testing
        location /test-green {
            proxy_pass http://green/;
        }

        # Main traffic goes to active environment
        location / {
            proxy_pass http://$backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
